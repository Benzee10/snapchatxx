import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient('https://vcgexvujgvfwbaktnwry.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjZ2V4dnVqZ3Zmd2Jha3Rud3J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxNjUzNDgsImV4cCI6MjA2NTc0MTM0OH0.6DvFHYliTSOloejLDWysgpjvS0f5YAm61q1Zq-OMU8k');

let models = [];

async function checkAndLoad() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return window.location.href = 'auth.html';

  const { data: u, error } = await supabase
    .from('users')
    .select('subscribed, subscription_expires')
    .eq('id', session.user.id)
    .single();

  if (error || !u) return alert('User data not found.');

  const now = new Date(), exp = new Date(u.subscription_expires);
  if (exp <= now) {
    await supabase.from('users').update({ subscribed: false }).eq('id', session.user.id);
    return showLocked();
  }

  if (!u.subscribed) return showLocked();

  document.getElementById('filters').style.display = 'flex';
  loadModels();
}

function showLocked() {
  document.getElementById('locked').style.display = 'block';
  document.getElementById('loader').style.display = 'none';
}

async function loadModels() {
  const { data, error } = await supabase
    .from('models')
    .select('*');

  if (error) return console.error('Load error', error);

  models = data;
  displayModels(models);
}

checkAndLoad();
